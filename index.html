<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>QuickTable UltraLite v41</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1520; --panel2:#101827; --border:#223047; --text:#e7ecf3;
    --push:#6d4b8e; --mr:#c24a4a; --limp:#7fcf7f;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.32 -apple-system,system-ui,Segoe UI,Roboto,Arial}

  /* Top chips */
  .bar{position:sticky;top:0;z-index:30;background:#101827;border-bottom:1px solid var(--border);padding:6px 8px;display:flex;align-items:center;gap:8px;justify-content:space-between}
  .chips{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#0f1624;font-size:12px}

  /* Floating Action Button (Ръка) */
  .fab{position:fixed;right:14px;bottom:14px;z-index:35;border:1px solid var(--border);background:#0f1624;color:var(--text);
        border-radius:14px;padding:14px 18px;font-weight:800;font-size:18px;box-shadow:0 6px 18px rgba(0,0,0,.35);cursor:pointer}

  /* Hand Builder overlay */
  .overlay{position:fixed;inset:0;background:#0b0f14;display:none;z-index:50;overflow-y:auto}
  .overlay.show{display:flex;flex-direction:column;justify-content:center;padding:26px 0}
  .hbBox{margin:0 auto;width:100%;max-width:620px;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--panel2)}
  .hbHead{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border)}
  .hbInner{padding:16px;background:var(--panel)}
  /* Grid: 5 cols ranks + 1 narrow col for S/O (aligned near row '2') */
  .hbGrid{display:grid;grid-template-columns:repeat(5,1fr) 66px;gap:12px;align-items:start}
  .rankGrid{grid-column:1 / 6;display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  .typeCol{grid-column:6;display:flex;flex-direction:column;gap:10px;justify-content:flex-end}
  .rankBtn{border:1px solid var(--border);background:#142035;border-radius:14px;padding:20px 0;font-weight:900;font-size:28px}
  .rankBtn.active{outline:2px solid #4da3ff}
  .typeBtn{border:1px solid var(--border);background:#111a2b;border-radius:12px;padding:14px 0;font-weight:800;font-size:18px}
  .typeBtn.active{outline:2px solid #4da3ff}

  .bbHead{margin:12px 0 8px;font-size:15px;opacity:.85;text-align:center}
  .bbGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:14px}
  .bbBtn{border:1px solid var(--border);background:#1a2740;border-radius:12px;padding:20px 0;font-weight:900;font-size:20px}
  .bbBtn.active{outline:2px solid #4da3ff}
  .clearBtn{border:1px solid var(--border);background:#0f1624;border-radius:12px;padding:14px 0;font-weight:800;font-size:16px;width:100%}

  /* Results */
  .wrap{max-width:1100px;margin:0 auto;padding:8px}
  .grid{display:grid;gap:8px}
  @media (min-width:980px){.grid{grid-template-columns:repeat(4,1fr)}}
  @media (max-width:979px){.grid{grid-template-columns:repeat(2,1fr)}}
  .col h2{margin:6px 0;font-size:14px;text-align:center;opacity:.9}
  .list{display:flex;flex-direction:column;gap:6px}
  .card{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--border);background:#0f1624;border-radius:10px;padding:12px;min-height:44px;cursor:pointer}
  .label{font-weight:800;font-size:14px}
  .val{font-weight:900;padding:6px 8px;border-radius:8px;min-width:96px;text-align:center;font-size:15px}

  /* Editor overlay (textarea) */
  .editOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:60;align-items:center;justify-content:center;padding:16px}
  .editOverlay.show{display:flex}
  .editBox{width:100%;max-width:620px;background:#0f1520;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .editHead{display:flex;align-items:center;justify-content:space-between;padding:10px;background:#101827;border-bottom:1px solid var(--border)}
  .editTitle{font-weight:900}
  .editBody{padding:10px}
  .editBody textarea{width:100%;min-height:240px;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;font:14px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .editFoot{display:flex;gap:8px;justify-content:flex-end;padding:10px;border-top:1px solid var(--border);background:#0f1520}
  .btn{border:1px solid var(--border);background:#0f1624;border-radius:12px;padding:10px 14px;font-weight:800}
  .btnWarn{background:#3a1212;border-color:#6b1f1f}
</style>
</head>
<body>
  <div class="bar">
    <div class="chips">
      <span class="chip">Ръка: <b id="curHand">—</b></span>
      <span class="chip">Стак: <b id="curStack">—</b></span>
    </div>
  </div>

  <!-- FAB: Ръка -->
  <button id="openHB" class="fab" type="button">Ръка</button>

  <!-- Hand Builder -->
  <div id="hb" class="overlay">
    <div class="hbBox">
      <div class="hbHead">
        <div><b>Избери ръка и блайнд</b></div>
        <button id="closeHB" class="btn" type="button" style="width:auto;padding:6px 10px;font-size:13px">X</button>
      </div>
      <div class="hbInner">
        <div class="hbGrid">
          <div class="rankGrid" id="rankGrid"></div>
          <div class="typeCol">
            <button class="typeBtn" data-type="s" type="button">S</button>
            <button class="typeBtn" data-type="o" type="button">O</button>
          </div>
        </div>

        <div class="bbHead">Блайндове (1–15)</div>
        <div class="bbGrid" id="bbGrid"></div>

        <button id="clearHand" class="clearBtn" type="button">Изчисти</button>
      </div>
    </div>
  </div>

  <!-- Резултати -->
  <div class="wrap" id="results">
    <div class="grid">
      <div class="col"><h2>HUSB & BU</h2><div class="list" id="R_HUSB"></div></div>
      <div class="col"><h2>HUBB</h2><div class="list" id="R_HUBB"></div></div>
      <div class="col"><h2>SB</h2><div class="list" id="R_SB"></div></div>
      <div class="col"><h2>BB</h2><div class="list" id="R_BB"></div></div>
    </div>
  </div>

  <!-- Editor overlay -->
  <div id="editModal" class="editOverlay">
    <div class="editBox">
      <div class="editHead">
        <div class="editTitle" id="editTitle">Редакция</div>
        <button id="editClose" class="btn" type="button">Затвори</button>
      </div>
      <div class="editBody">
        <textarea id="editArea" spellcheck="false" placeholder="Пример:
AJo = L-C-AI
default = Fold

(За PUSH позиции — само числа)
AJo = 45
default = 38"></textarea>
      </div>
      <div class="editFoot">
        <button id="editClear" class="btn btnWarn" type="button">Изчисти</button>
        <button id="editSave" class="btn" type="button">Запази</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // Colors & aliases
  const COLORS={"FOLD":"#f4f6fa","L-F-F":"#a7e8a7","L-C-F":"#155d15","L-C-AI":"#bcdcf3","L-R-AI":"#0b3a94","MR-F-F":"#ffe27a","MR-C-AI":"#7b4a2a","MR-4B-AI":"#e44747","SHOVE":"#6d4b8e"};
  const norm=s=>(s||"").toUpperCase().replace(/\s+/g,"");
  const isPushPos=p=>/PUSH/i.test(p);
  const alias=(key,act)=>{const up=(act||"").toUpperCase(); if(!(key==="BBvsSB_L"||key==="HUBB_L"))return{d:act,c:null};
    if(up==="MR-F-F")return{d:"Check/Call",c:COLORS["MR-F-F"]};
    if(up==="L-C-AI")return{d:"ISO/Call",c:COLORS["L-C-AI"]};
    if(up==="SHOVE")return{d:"ISO/3bet AI",c:COLORS["SHOVE"]};
    if(up==="MR-4B-AI")return{d:"ISO/3bet/Fold",c:COLORS["MR-4B-AI"]};
    return{d:act,c:null};};

  // DB
  let DB=JSON.parse(localStorage.getItem("qt_v41")||"{}");
  const k=(p,r)=>p+"||"+r; const get=(p,r)=>DB[k(p,r)]?.raw||""; const set=(p,r,raw)=>{DB[k(p,r)]={raw};localStorage.setItem("qt_v41",JSON.stringify(DB))};

  function parseRaw(raw,push=false){ if(!raw)return{def:null,map:{}}; let def=null,map={};
    raw.split(/\r?\n|;/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
      const m=line.split("="); if(m.length===1){const v=m[0].trim(); if(!v)return; def=push?parseFloat(v):v.toUpperCase();}
      else{const h=norm(m[0]); const v=m.slice(1).join("=").trim();
        if(/^DEFAULT$/i.test(h)) def=push?parseFloat(v):v.toUpperCase();
        else if(h) map[h]=push?parseFloat(v):v.toUpperCase(); }
    }); return{def,map}; }

  // Groups
  const GROUPS={
    HUSB:[{label:"HUSB",key:"HUSB",neutral:true},{label:"BU",key:"BU",neutral:true}],
    HUBB:[{label:"HUBB (Limp)",key:"HUBB_L"},{label:"HUBB (MR)",key:"HUBB_MR"},{label:"HUBB (Push)",key:"HUBBv_PUSH"}],
    SB:[{label:"SBvsBU (MR)",key:"SBvsBU"},{label:"SBvsBU (Push)",key:"SBvsBU_PUSH"},{label:"SBvsBB",key:"SBvsBB",neutral:true}],
    BB:[{label:"BBvsBU (MR)",key:"BBvsBU_MR"},{label:"BBvsBU (Push)",key:"BBvsBU_PUSH"},{label:"BBvsSB (Limp)",key:"BBvsSB_L"},{label:"BBvsSB (MR)",key:"BBvsSB_MR"},{label:"BBvsSB (Push)",key:"BBvsSB_PUSH"}]
  };

  // State
  const ranks=["A","K","Q","J","T","9","8","7","6","5","4","3","2"];
  let first=null,second=null,type=null,stackR=null,bbChoice=null;
  const curHandEl=document.getElementById("curHand"), curStackEl=document.getElementById("curStack");
  const hb=document.getElementById("hb");

  // Helpers
  const handText=()=>{ if(!first||!second) return null; if(first===second) return first+second; return first+second+(type==="pair"?"":type||""); };
  const mapBB=n=>{n=+n; if(n<=4)return"0–4"; if(n<=7)return"4–7"; if(n<=10)return"7–10"; if(n<=13)return"10–13"; return"13+";};

  // FAB
  document.getElementById("openHB").addEventListener("click", ()=> hb.classList.add("show"));
  document.getElementById("closeHB").addEventListener("click", ()=> hb.classList.remove("show"));

  // Ranks
  const rankGrid=document.getElementById("rankGrid");
  ranks.forEach(r=>{ const b=document.createElement("button"); b.className="rankBtn"; b.textContent=r; b.type="button";
    b.addEventListener("click", ()=>{
      if(!first){ first=r; b.classList.add("active"); }
      else if(!second){ second=r; }
      else{ first=r; second=null; rankGrid.querySelectorAll(".rankBtn").forEach(x=>x.classList.remove("active")); b.classList.add("active"); }
      if(first && second && first===second){ type="pair"; setTypeButtons("pair"); } // авто-пейр
      maybeCloseHB(); renderIfReady();
    });
    rankGrid.appendChild(b);
  });

  // Type S/O (в тесната колона)
  function setTypeButtons(t){ document.querySelectorAll(".typeBtn").forEach(x=>x.classList.toggle("active", x.dataset.type===t)); }
  document.querySelectorAll(".typeBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{ type=btn.dataset.type; setTypeButtons(type); maybeCloseHB(); renderIfReady(); });
  });

  // Blinds 1–15
  const bbGrid=document.getElementById("bbGrid");
  for(let i=1;i<=15;i++){
    const b=document.createElement("button"); b.className="bbBtn"; b.textContent=String(i); b.type="button";
    b.addEventListener("click", ()=>{
      bbChoice=i; bbGrid.querySelectorAll(".bbBtn").forEach(x=>x.classList.remove("active")); b.classList.add("active");
      stackR = mapBB(i); curStackEl.textContent=stackR; maybeCloseHB(); renderIfReady();
    });
    bbGrid.appendChild(b);
  }

  document.getElementById("clearHand").addEventListener("click", ()=>{
    first=second=type=bbChoice=null; rankGrid.querySelectorAll(".rankBtn").forEach(x=>x.classList.remove("active"));
    setTypeButtons(""); bbGrid.querySelectorAll(".bbBtn").forEach(x=>x.classList.remove("active"));
    hb.classList.add("show"); renderIfReady();
  });

  function maybeCloseHB(){
    if(first && second && bbChoice){
      if(first===second && type==="pair"){ hb.classList.remove("show"); return; }
      if(first!==second && (type==="s"||type==="o")){ hb.classList.remove("show"); return; }
    }
  }

  // Rendering
  function compute(pos,h,stk){
    const push=isPushPos(pos); const {def,map}=parseRaw(get(pos,stk),push); const hh=norm(h);
    if(push){const v=map[hh]!=null?map[hh]:def; return{disp:v==null?"—":String(Math.round(v*10)/10),num:v!=null,color:null,act:v};}
    else{const act=(map[hh]||def||"—"); const a=alias(pos,act); return{disp:a.d,num:false,color:a.c,act:act};}
  }
  const bg=(lab,key,val,neutral)=>{
    if(neutral) return "#0f1624";
    if(/Push/i.test(lab)||/PUSH$/.test(key)||/^\d+(\.\d+)?$/.test(val)) return getComputedStyle(document.documentElement).getPropertyValue('--push');
    if(/\(MR\)/i.test(lab)||/_MR$/.test(key)) return getComputedStyle(document.documentElement).getPropertyValue('--mr');
    if(/\(Limp\)/i.test(lab)||/_L$/.test(key)||key==="BU"||key==="HUSB") return getComputedStyle(document.documentElement).getPropertyValue('--limp');
    return "#0f1624";
  };

  function openEditor(label,key,stk){
    editCtx={key,stk};
    editTitle.textContent=`Редакция: ${label} × ${stk}`;
    editArea.value=get(key,stk)||"";
    editModal.classList.add("show");
    editArea.focus();
  }

  function render(h,stk){
    ["R_HUSB","R_HUBB","R_SB","R_BB"].forEach(id=> document.getElementById(id).innerHTML="");
    const addRow=(container,label,key,neutral)=>{
      const c=compute(key,h,stk);
      const row=document.createElement("div"); row.className="card";
      const lab=document.createElement("div"); lab.className="label"; lab.textContent=label;
      const val=document.createElement("div"); val.className="val"; val.textContent=c.disp;
      row.style.background=bg(label,key,c.disp,!!neutral);
      if(c.color){ val.style.background=c.color; val.style.color="#000"; }
      else if(c.num){ val.style.background="rgba(0,0,0,.22)"; val.style.color="#fff"; }
      else{ const col = COLORS[(c.disp+"").toUpperCase()] || COLORS[(c.act+"").toUpperCase()] || '#2a2f3c'; val.style.background=col; val.style.color="#000"; }
      row.addEventListener("click", ()=> openEditor(label,key,stk));
      row.appendChild(lab); row.appendChild(val);
      document.getElementById(container).appendChild(row);
    };
    GROUPS.HUSB.forEach(it=>addRow("R_HUSB",it.label,it.key,it.neutral));
    GROUPS.HUBB.forEach(it=>addRow("R_HUBB",it.label,it.key,it.neutral));
    GROUPS.SB  .forEach(it=>addRow("R_SB",  it.label,it.key,it.neutral));
    GROUPS.BB  .forEach(it=>addRow("R_BB",  it.label,it.key,it.neutral));
  }

  function renderIfReady(){
    const h=handText(); curHandEl.textContent=h||"—"; curStackEl.textContent=stackR||"—";
    if(h && stackR){ render(h,stackR); }
  }

  // Editor overlay
  const editModal=document.getElementById("editModal");
  const editTitle=document.getElementById("editTitle");
  const editArea=document.getElementById("editArea");
  const editClose=document.getElementById("editClose");
  const editSave=document.getElementById("editSave");
  const editClear=document.getElementById("editClear");
  let editCtx=null;

  editClose.addEventListener("click", ()=>{ editModal.classList.remove("show"); editCtx=null; });
  editSave.addEventListener("click", ()=>{
    if(!editCtx) return; set(editCtx.key, editCtx.stk, editArea.value); editModal.classList.remove("show"); renderIfReady();
  });
  editClear.addEventListener("click", ()=>{
    if(!editCtx) return; if(confirm("Да изчистя ли напълно тази клетка?")){ set(editCtx.key, editCtx.stk, ""); editModal.classList.remove("show"); renderIfReady(); }
  });

  // Първоначално: отваряме Hand Builder
  hb.classList.add("show");
})();
</script>
</body>
</html>
